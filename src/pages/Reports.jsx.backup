import React, { useState } from 'react';
import { useApp } from '../context/AppContext';
import Card, { CardHeader, CardContent } from '../components/ui/Card';
import Button from '../components/ui/Button';
import Input from '../components/ui/Input';
import Modal from '../components/ui/Modal';
import Pagination from '../components/ui/Pagination';
import { FileText, Printer, Calendar, CheckCircle, Clock, Mail, MessageCircle, Download } from 'lucide-react';
import { generatePDFReport } from '../utils/pdfGenerator';
const [emailData, setEmailData] = useState({
    to: '',
    observations: ''
});
const [sendingEmail, setSendingEmail] = useState(false);
const [currentPage, setCurrentPage] = useState(1);

// Reset page when filters change
React.useEffect(() => {
    setCurrentPage(1);
}, [filters.status]);

const generateReport = () => {
    if (!filters.startDate || !filters.endDate) {
        return;
    }

    let filteredPrescriptions = prescriptions;
    if (filters.patientId !== 'all') {
        filteredPrescriptions = prescriptions.filter(
            p => p.patientId === filters.patientId
        );
    }

    const expectedDoses = [];
    filteredPrescriptions.forEach(prescription => {
        const prescStart = new Date(prescription.startDate);
        const filterStart = new Date(filters.startDate);
        const filterEnd = new Date(filters.endDate);

        const start = new Date(Math.max(prescStart, filterStart));
        const end = new Date(filterEnd);

        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            prescription.times.forEach(time => {
                expectedDoses.push({
                    date: d.toISOString().split('T')[0],
                    time: time,
                    patientId: prescription.patientId,
                    medicationId: prescription.medicationId,
                    prescriptionId: prescription.id
                });
            });
        }
    });

    const reportItems = expectedDoses.map(dose => {
        const patient = patients.find(p => p.id === dose.patientId);
        const medication = medications.find(m => m.id === dose.medicationId);

        // Check if this dose was taken
        // consumptionLog structure: { prescriptionId, scheduledTime, date, status }
        const taken = consumptionLog.find(log => {
            const match = log.prescriptionId === dose.prescriptionId &&
                log.date === dose.date &&
                log.scheduledTime === dose.time;

            // Debug logging
            if (match) {
                console.log('‚úÖ Match found:', {
                    prescriptionId: dose.prescriptionId,
                    date: dose.date,
                    time: dose.time,
                    log
                });
            }

            return match;
        });

        return {
            date: dose.date,
            time: dose.time,
            patient: patient?.name || 'Desconhecido',
            medication: `${medication?.name} ${medication?.dosage}`,
            status: taken ? 'taken' : 'pending',
            takenAt: taken?.timestamp
        };
    });

    // Sort by date and time (chronological order)
    reportItems.sort((a, b) => {
        // First compare dates
        const dateCompare = a.date.localeCompare(b.date);
        if (dateCompare !== 0) return dateCompare;
        // If dates are equal, compare times
        return a.time.localeCompare(b.time);
    });

    // Debug: Log summary
    console.log('üìä Report Summary:', {
        totalDoses: reportItems.length,
        taken: reportItems.filter(i => i.status === 'taken').length,
        pending: reportItems.filter(i => i.status === 'pending').length,
        consumptionLogEntries: consumptionLog.length
    });

    const summary = {
        total: reportItems.length,
        taken: reportItems.filter(i => i.status === 'taken').length,
        pending: reportItems.filter(i => i.status === 'pending').length
    };
    summary.adherenceRate = summary.total > 0
        ? Math.round((summary.taken / summary.total) * 100)
        : 0;

    setReportData({
        filters,
        summary,
        items: reportItems.sort((a, b) =>
            `${a.date} ${a.time}`.localeCompare(`${b.date} ${b.time}`)
        )
    });
};

const handlePrint = () => {
    window.print();
};

const handleDownloadPDF = () => {
    try {
        generatePDFReport(reportData, filters, patients);
        showToast('PDF gerado com sucesso!', 'success');
    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        showToast('Erro ao gerar PDF', 'error');
    }
};

const generateReportText = () => {
    if (!reportData) return '';

    const filteredItems = reportData.items.filter(
        item => filters.status === 'all' || item.status === filters.status
    );

    let text = `RELATORIO DE MEDICACOES\n\n`;
    text += `Periodo: ${new Date(reportData.filters.startDate).toLocaleDateString('pt-BR')} ate ${new Date(reportData.filters.endDate).toLocaleDateString('pt-BR')}\n`;

    if (reportData.filters.patientId !== 'all') {
        const patient = patients.find(p => p.id === reportData.filters.patientId);
        text += `Paciente: ${patient?.name}\n`;
    }

    text += `\nRESUMO\n`;
    text += `Total: ${reportData.summary.total}\n`;
    text += `Tomadas: ${reportData.summary.taken}\n`;
    text += `Pendentes: ${reportData.summary.pending}\n`;
    text += `Taxa de Adesao: ${reportData.summary.adherenceRate}%\n`;

    text += `\nDETALHAMENTO\n`;
    filteredItems.slice(0, 20).forEach((item, idx) => {
        const status = item.status === 'taken' ? '[TOMADO]' : '[PENDENTE]';
        text += `\n${idx + 1}. ${status} ${new Date(item.date).toLocaleDateString('pt-BR')} as ${item.time}\n`;
        text += `   ${item.patient} - ${item.medication}\n`;
    });

    if (filteredItems.length > 20) {
        text += `\n... e mais ${filteredItems.length - 20} medicacoes\n`;
    }

    text += `\n---\nGerado pelo Sistema de Controle de Medicamentos`;

    return text;
};

const handleWhatsApp = () => {
    const text = generateReportText();
    const encodedText = encodeURIComponent(text);
    window.open(`https://wa.me/?text=${encodedText}`, '_blank');
};

const handleEmail = () => {
    setShowEmailModal(true);
};

const handleSendEmail = async () => {
    if (!emailData.to) {
        showToast('Por favor, informe o email do destinat√°rio', 'error');
        return;
    }

    setSendingEmail(true);

    try {
        const text = generateReportText();
        const subject = `Relatorio de Medicacoes - ${new Date(reportData.filters.startDate).toLocaleDateString('pt-BR')} a ${new Date(reportData.filters.endDate).toLocaleDateString('pt-BR')}`;

        const response = await fetch('http://localhost:3001/api/send-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                to: emailData.to,
                subject: subject,
                text: text,
                observations: emailData.observations
            })
        });

        const result = await response.json();

        if (result.success) {
            showToast('Email enviado com sucesso!', 'success');
            setShowEmailModal(false);
            setEmailData({ to: '', observations: '' });
        } else {
            throw new Error(result.error || 'Erro ao enviar email');
        }
    } catch (error) {
        console.error('Erro ao enviar email:', error);
        showToast(error.message || 'Erro ao enviar email. Verifique se o servidor est√° rodando.', 'error');
    } finally {
        setSendingEmail(false);
    }
};

return (
    <div className="flex flex-col gap-8 pb-24 animate-in fade-in duration-500">
        <div className="no-print">
            <h2 className="text-3xl font-bold text-slate-900 tracking-tight">Relat√≥rios</h2>
            <p className="text-slate-500 mt-1">Visualize e imprima relat√≥rios de medica√ß√µes.</p>
        </div>

        <Card className="no-print">
            <CardHeader>
                <h3 className="font-bold text-xl text-slate-900">Filtros do Relat√≥rio</h3>
                <p className="text-sm text-slate-500">Selecione o paciente, per√≠odo e status desejado</p>
            </CardHeader>
            <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div className="flex flex-col gap-1.5">
                        <label className="text-sm font-semibold text-slate-700 ml-1">
                            Paciente
                        </label>
                        <select
                            className="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white text-slate-900 focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all duration-200"
                            value={filters.patientId}
                            onChange={e => setFilters({ ...filters, patientId: e.target.value })}
                        >
                            <option value="all">Todos os Pacientes</option>
                            {patients.map(p => (
                                <option key={p.id} value={p.id}>{p.name}</option>
                            ))}
                        </select>
                    </div>

                    <Input
                        label="Data In√≠cio"
                        type="date"
                        value={filters.startDate}
                        onChange={e => setFilters({ ...filters, startDate: e.target.value })}
                        required
                    />

                    <Input
                        label="Data Fim"
                        type="date"
                        value={filters.endDate}
                        onChange={e => setFilters({ ...filters, endDate: e.target.value })}
                        required
                    />

                    <div className="flex flex-col gap-1.5">
                        <label className="text-sm font-semibold text-slate-700 ml-1">
                            Status
                        </label>
                        <select
                            className="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white text-slate-900 focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all duration-200"
                            value={filters.status}
                            onChange={e => setFilters({ ...filters, status: e.target.value })}
                        >
                            <option value="all">Todos</option>
                            <option value="taken">Tomadas</option>
                            <option value="pending">Pendentes</option>
                        </select>
                    </div>
                </div>

                <div className="flex gap-2 mt-4">
                    <Button
                        onClick={generateReport}
                        className="flex-1"
                        disabled={!filters.startDate || !filters.endDate}
                    >
                        <FileText size={18} className="mr-2" />
                        Gerar
                    </Button>
                    {reportData && (
                        <>
                            <Button onClick={handleDownloadPDF} variant="outline" title="Download PDF" className="text-primary hover:text-primary hover:bg-primary/10">
                                <Download size={18} />
                            </Button>
                            <Button onClick={handlePrint} variant="outline" title="Imprimir">
                                <Printer size={18} />
                            </Button>
                            <Button onClick={handleWhatsApp} variant="outline" title="Enviar por WhatsApp" className="text-green-600 hover:text-green-700 hover:bg-green-50">
                                <MessageCircle size={18} />
                            </Button>
                            <Button onClick={handleEmail} variant="outline" title="Enviar por Email" className="text-blue-600 hover:text-blue-700 hover:bg-blue-50">
                                <Mail size={18} />
                            </Button>
                        </>
                    )}
                </div>
            </CardContent>
        </Card>

        {reportData && (
            <Card className="print-section">
                <CardHeader className="print-header">
                    <h2 className="text-2xl font-bold text-slate-900">Relat√≥rio de Medica√ß√µes</h2>
                    <p className="text-sm text-slate-500">
                        Per√≠odo: {new Date(reportData.filters.startDate).toLocaleDateString('pt-BR')}
                        {' at√© '}
                        {new Date(reportData.filters.endDate).toLocaleDateString('pt-BR')}
                        {reportData.filters.patientId !== 'all' && (
                            <> ‚Ä¢ Paciente: {patients.find(p => p.id === reportData.filters.patientId)?.name}</>
                        )}
                    </p>
                </CardHeader>

                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 p-6 bg-slate-50 border-b">
                    <div className="text-center">
                        <p className="text-3xl font-bold text-primary">{reportData.summary.total}</p>
                        <p className="text-sm text-slate-600">Total</p>
                    </div>
                    <div className="text-center">
                        <p className="text-3xl font-bold text-green-600">{reportData.summary.taken}</p>
                        <p className="text-sm text-slate-600">Tomadas</p>
                    </div>
                    <div className="text-center">
                        <p className="text-3xl font-bold text-orange-600">{reportData.summary.pending}</p>
                        <p className="text-sm text-slate-600">Pendentes</p>
                    </div>
                    <div className="text-center">
                        <p className="text-3xl font-bold text-blue-600">{reportData.summary.adherenceRate}%</p>
                        <p className="text-sm text-slate-600">Ades√£o</p>
                    </div>
                </div>

                <CardContent>
                    {(() => {
                        const filteredItems = reportData.items.filter(item => filters.status === 'all' || item.status === filters.status);
                        const totalPages = Math.ceil(filteredItems.length / ITEMS_PER_PAGE);
                        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
                        const paginatedItems = filteredItems.slice(startIndex, startIndex + ITEMS_PER_PAGE);

                        return filteredItems.length === 0 ? (
                            <div className="text-center py-12 text-slate-500">
                                <Calendar size={48} className="mx-auto mb-4 opacity-50" />
                                <p>Nenhuma medica√ß√£o encontrada com os filtros selecionados.</p>
                            </div>
                        ) : (
                            <>
                                {/* Screen View - Paginated */}
                                <div className="no-print">
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead>
                                                <tr className="border-b-2 border-slate-200">
                                                    <th className="text-left p-3 font-semibold text-slate-700">Data</th>
                                                    <th className="text-left p-3 font-semibold text-slate-700">Hora</th>
                                                    <th className="text-left p-3 font-semibold text-slate-700">Paciente</th>
                                                    <th className="text-left p-3 font-semibold text-slate-700">Medicamento</th>
                                                    <th className="text-left p-3 font-semibold text-slate-700">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {paginatedItems.map((item, idx) => (
                                                    <tr key={idx} className="border-b border-slate-100 hover:bg-slate-50 transition-colors">
                                                        <td className="p-3 text-slate-900" style={{ minWidth: '100px' }}>
                                                            {new Date(item.date).toLocaleDateString('pt-BR')}
                                                        </td>
                                                        <td className="p-3 text-slate-900" style={{ minWidth: '70px' }}>{item.time}</td>
                                                        <td className="p-3 text-slate-900" style={{ minWidth: '150px' }}>{item.patient}</td>
                                                        <td className="p-3 text-slate-900" style={{ minWidth: '180px' }}>{item.medication}</td>
                                                        <td className="p-3" style={{ minWidth: '110px' }}>
                                                            {item.status === 'taken' ? (
                                                                <span className="flex items-center gap-1.5 text-green-600 font-medium">
                                                                    <CheckCircle size={16} />
                                                                    Tomado
                                                                </span>
                                                            ) : (
                                                                <span className="flex items-center gap-1.5 text-orange-600 font-medium">
                                                                    <Clock size={16} />
                                                                    Pendente
                                                                </span>
                                                            )}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>

                                    {/* Pagination */}
                                    <Pagination
                                        currentPage={currentPage}
                                        totalPages={totalPages}
                                        onPageChange={setCurrentPage}
                                    />
                                </div>

                                {/* Print View - All Items */}
                                <div className="print-only" style={{ display: 'none' }}>
                                    <div className="overflow-x-auto">
                                        <table className="w-full">
                                            <thead>
                                                <tr className="border-b-2 border-slate-200">
                                                    <th className="text-left p-3 font-semibold text-slate-700">Data</th>
                                                    <th className="text-left p-3 font-semibold text-slate-700">Hora</th>
                                                    <th className="text-left p-3 font-semibold text-slate-700">Paciente</th>
                                                    <th className="text-left p-3 font-semibold text-slate-700">Medicamento</th>
                                                    <th className="text-left p-3 font-semibold text-slate-700">Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {filteredItems.map((item, idx) => (
                                                    <tr key={idx} className="border-b border-slate-100">
                                                        <td className="p-3 text-slate-900" style={{ minWidth: '100px' }}>
                                                            {new Date(item.date).toLocaleDateString('pt-BR')}
                                                        </td>
                                                        <td className="p-3 text-slate-900" style={{ minWidth: '70px' }}>{item.time}</td>
                                                        <td className="p-3 text-slate-900" style={{ minWidth: '150px' }}>{item.patient}</td>
                                                        <td className="p-3 text-slate-900" style={{ minWidth: '180px' }}>{item.medication}</td>
                                                        <td className="p-3" style={{ minWidth: '110px' }}>
                                                            {item.status === 'taken' ? (
                                                                <span className="flex items-center gap-1.5 text-green-600 font-medium">
                                                                    <CheckCircle size={16} />
                                                                    Tomado
                                                                </span>
                                                            ) : (
                                                                <span className="flex items-center gap-1.5 text-orange-600 font-medium">
                                                                    <Clock size={16} />
                                                                    Pendente
                                                                </span>
                                                            )}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </>
                        );
                    })()}
                </CardContent>
            </Card>
        )}

        {!reportData && (
            <Card className="border-dashed no-print">
                <CardContent className="text-center py-12">
                    <FileText size={48} className="mx-auto mb-4 text-slate-300" />
                    <h3 className="text-xl font-bold text-slate-900 mb-2">
                        Selecione os filtros acima
                    </h3>
                    <p className="text-slate-500">
                        Escolha o paciente, per√≠odo e status para gerar o relat√≥rio de medica√ß√µes.
                    </p>
                </CardContent>
            </Card>
        )}

        <Modal
            isOpen={showEmailModal}
            onClose={() => setShowEmailModal(false)}
            title="Enviar Relat√≥rio por Email"
        >
            <div className="space-y-4">
                <Input
                    label="Email do Destinat√°rio"
                    type="email"
                    value={emailData.to}
                    onChange={e => setEmailData({ ...emailData, to: e.target.value })}
                    placeholder="exemplo@email.com"
                    required
                />

                <div className="flex flex-col gap-1.5">
                    <label className="text-sm font-semibold text-slate-700 ml-1">
                        Observa√ß√µes (Opcional)
                    </label>
                    <textarea
                        className="w-full px-4 py-3 rounded-xl border border-slate-200 bg-white text-slate-900 focus:outline-none focus:border-primary focus:ring-4 focus:ring-primary/10 transition-all duration-200 min-h-[100px]"
                        value={emailData.observations}
                        onChange={e => setEmailData({ ...emailData, observations: e.target.value })}
                        placeholder="Digite observa√ß√µes que ser√£o inclu√≠das no email..."
                    />
                </div>

                <div className="flex gap-3 mt-6">
                    <Button
                        onClick={() => setShowEmailModal(false)}
                        variant="outline"
                        className="flex-1"
                    >
                        Cancelar
                    </Button>
                    <Button
                        onClick={handleSendEmail}
                        className="flex-1"
                        disabled={sendingEmail}
                    >
                        <Mail size={18} className="mr-2" />
                        {sendingEmail ? 'Enviando...' : 'Enviar'}
                    </Button>
                </div>
            </div>
        </Modal>
    </div>
);
};

export default Reports;
