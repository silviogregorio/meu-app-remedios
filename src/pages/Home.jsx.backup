import React, { useState, useEffect } from 'react';
import { useApp } from '../context/AppContext';
import Card, { CardContent } from '../components/ui/Card';
import Button from '../components/ui/Button';
import Pagination from '../components/ui/Pagination';
import { Check, Clock, AlertCircle, Calendar, User, Pill, X } from 'lucide-react';
import { format } from 'date-fns';
import { ptBR } from 'date-fns/locale';
import clsx from 'clsx';

const ITEMS_PER_PAGE = 6;

const Home = () => {
    const { user, prescriptions, medications, patients, consumptionLog, logConsumption, removeConsumption } = useApp();
    const [todaysSchedule, setTodaysSchedule] = useState([]);
    const [currentPage, setCurrentPage] = useState(1);

    // Filters
    const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
    const [selectedPatient, setSelectedPatient] = useState('all');
    const [selectedMedication, setSelectedMedication] = useState('all');
    const [selectedStatus, setSelectedStatus] = useState('all');

    useEffect(() => {
        // Generate schedule based on prescriptions and filters
        const schedule = [];

        prescriptions.forEach(presc => {
            const med = medications.find(m => m.id === presc.medicationId);
            const patient = patients.find(p => p.id === presc.patientId);

            // Apply patient filter
            if (selectedPatient !== 'all' && presc.patientId !== selectedPatient) return;

            // Apply medication filter
            if (selectedMedication !== 'all' && presc.medicationId !== selectedMedication) return;

            presc.times.forEach(time => {
                // Check if already taken on selected date
                const isTaken = consumptionLog.some(log =>
                    log.prescriptionId === presc.id &&
                    log.scheduledTime === time &&
                    log.date === selectedDate
                );

                schedule.push({
                    id: `${presc.id}-${time}`,
                    prescriptionId: presc.id,
                    medicationName: med?.name,
                    dosage: med?.dosage,
                    patientName: patient?.name,
                    patientId: patient?.id,
                    time: time,
                    isTaken: isTaken,
                    status: isTaken ? 'taken' : 'pending'
                });
            });
        });

        // Sort by time
        schedule.sort((a, b) => a.time.localeCompare(b.time));
        setTodaysSchedule(schedule);
        setCurrentPage(1); // Reset page when schedule changes
    }, [prescriptions, medications, patients, consumptionLog, selectedDate, selectedPatient, selectedMedication]);

    const handleToggleStatus = (item) => {
        if (item.isTaken) {
            // Remove consumption log
            removeConsumption(item.prescriptionId, item.time, selectedDate);
        } else {
            // Add consumption log
            logConsumption({
                prescriptionId: item.prescriptionId,
                scheduledTime: item.time,
                date: selectedDate,
                status: 'taken'
            });
        }
    };

            </div >

    {/* Stats Cards */ }
    < div className = "flex gap-4 overflow-x-auto pb-2 -mx-4 px-4" >
                <Card className="min-w-[140px] !bg-[#0f766e] !text-white border-none shadow-lg shadow-teal-600/20">
                    <CardContent className="p-4 flex flex-col gap-2">
                        <span className="text-3xl font-bold !text-white">
                            {todaysSchedule.filter(i => i.isTaken).length}/{todaysSchedule.length}
                        </span>
                        <span className="text-sm font-medium !text-white">Tomados hoje</span>
                    </CardContent>
                </Card>
                <Card className="min-w-[140px]">
                    <CardContent className="p-4 flex flex-col gap-2">
                        <span className="text-3xl font-bold text-[#f59e0b]">
                            {todaysSchedule.filter(i => !i.isTaken).length}
                        </span>
                        <span className="text-sm font-medium text-[#64748b]">Pendentes</span>
                    </CardContent>
                </Card>
            </div >

    {/* Filters Section */ }
    < Card className = "border-l-4 border-l-primary" >
        <CardContent className="p-4">
            <div className="flex items-center justify-between mb-3">
                <h3 className="font-bold text-slate-900 flex items-center gap-2">
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    Filtros
                </h3>
                {hasActiveFilters && (
                    <button
                        onClick={clearFilters}
                        className="text-xs text-slate-500 hover:text-primary flex items-center gap-1"
                    >
                        <X size={14} />
                        Limpar
                    </button>
                )}
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                {/* Date Filter */}
                <div className="flex flex-col gap-1.5">
                    <label className="text-xs font-medium text-slate-600 flex items-center gap-1">
                        <Calendar size={14} />
                        Data
                    </label>
                    <input
                        type="date"
                        value={selectedDate}
                        onChange={(e) => setSelectedDate(e.target.value)}
                        className="px-3 py-2 rounded-lg border border-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
                    />
                </div>

                {/* Patient Filter */}
                <div className="flex flex-col gap-1.5">
                    <label className="text-xs font-medium text-slate-600 flex items-center gap-1">
                        <User size={14} />
                        Paciente
                    </label>
                    <select
                        value={selectedPatient}
                        onChange={(e) => setSelectedPatient(e.target.value)}
                        className="px-3 py-2 rounded-lg border border-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
                    >
                        <option value="all">Todos os pacientes</option>
                        {patients.map(patient => (
                            <option key={patient.id} value={patient.id}>{patient.name}</option>
                        ))}
                    </select>
                </div>

                {/* Medication Filter */}
                <div className="flex flex-col gap-1.5">
                    <label className="text-xs font-medium text-slate-600 flex items-center gap-1">
                        <Pill size={14} />
                        Medicamento
                    </label>
                    <select
                        value={selectedMedication}
                        onChange={(e) => setSelectedMedication(e.target.value)}
                        className="px-3 py-2 rounded-lg border border-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
                    >
                        <option value="all">Todos os medicamentos</option>
                        {medications.map(med => (
                            <option key={med.id} value={med.id}>{med.name} {med.dosage}</option>
                        ))}
                    </select>
                </div>
            </div>
        </CardContent>
            </Card >

    {/* Schedule List */ }
    < div >
                <h2 className="text-lg font-bold text-[#0f172a] mb-4">
                    {selectedDate === new Date().toISOString().split('T')[0] ? 'Próximos Horários' : 'Horários do Dia'}
                </h2>
                <div className="flex flex-col gap-3">
                    {(() => {
                        const totalPages = Math.ceil(todaysSchedule.length / ITEMS_PER_PAGE);
                        const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
                        const paginatedSchedule = todaysSchedule.slice(startIndex, startIndex + ITEMS_PER_PAGE);

                        return todaysSchedule.length === 0 ? (
                            <Card className="border-dashed">
                                <CardContent className="py-8 text-center">
                                    <p className="text-[#64748b]">
                                        {hasActiveFilters
                                            ? 'Nenhum medicamento encontrado com estes filtros.'
                                            : 'Nenhum medicamento agendado para esta data.'}
                                    </p>
                                </CardContent>
                            </Card>
                        ) : (
                            <>
                                {paginatedSchedule.map(item => (
                                    <Card key={item.id} className={clsx("transition-all", item.isTaken && "opacity-60 bg-[#f8fafc]")}>
                                        <CardContent className="flex items-center justify-between p-4">
                                            <div className="flex items-center gap-4 flex-1">
                                                <div className={clsx(
                                                    "w-12 h-12 rounded-xl flex flex-col items-center justify-center font-bold border",
                                                    item.isTaken
                                                        ? "bg-[#d1fae5] text-[#059669] border-[#d1fae5]"
                                                        : "bg-white text-[#0f172a] border-[#e2e8f0]"
                                                )}>
                                                    <span className="text-sm">{item.time}</span>
                                                </div>
                                                <div className="flex-1 min-w-0">
                                                    <h3 className={clsx("font-bold", item.isTaken ? "text-[#64748b] line-through" : "text-[#0f172a]")}>
                                                        {item.medicationName} {item.dosage}
                                                    </h3>
                                                    <p className="text-sm text-[#64748b]">{item.patientName}</p>
                                                </div>
                                            </div>

                                            <button
                                                onClick={() => handleTake(item)}
                                                disabled={item.isTaken}
                                                className={clsx(
                                                    "w-10 h-10 rounded-full flex items-center justify-center transition-all shrink-0",
                                                    item.isTaken
                                                        ? "bg-[#10b981] text-white cursor-default"
                                                        : "bg-[#f1f5f9] text-[#94a3b8] hover:bg-[#e2e8f0] hover:text-[#64748b]"
                                                )}
                                            >
                                                <Check size={20} />
                                            </button>
                                        </CardContent>
                                    </Card>
                                ))}

                                {/* Pagination */}
                                <Pagination
                                    currentPage={currentPage}
                                    totalPages={totalPages}
                                    onPageChange={setCurrentPage}
                                />
                            </>
                        );
                    })()}
                </div>
            </div >
        </div >
    );
};

export default Home;

